// Detecting WafflesExploits Shellcode in Image Files
// https://wafflesexploits.github.io/posts/Hide_a_Payload_in_Plain_Sight_Embedding_Shellcode_in_a_Image_file/

let ImageExtension = dynamic([".apng", ".png", ".avif", ".gif", ".jpg", ".jpeg", ".jfif", ".pjpeg", ".pjp", ".png", ".svg", ".webp", ".bmp", ".tif", ".tiff"]);
let CPPId = dynamic(["Microsoft Visual C++"]);
let WhiteListedFileName = dynamic(["logo.png","vcredist.bmp","watermark.bmp","header.bmp","SplashScreen.bmp"]);
DeviceFileEvents
| where InitiatingProcessVersionInfoFileDescription has_any(CPPId)
| where ActionType == @"FileCreated"
| where FileName has_any(ImageExtension)
| where not(FileName has_any(WhiteListedFileName))

